name: Test Notebooks

on:
  workflow_call: # Make this workflow reusable
    inputs:
      python-versions:
        description: 'Python versions to test'
        required: false
        default: "['3.8', '3.9', '3.11', '3.12', '3.13', '3.14']"
        type: string

jobs:
  test-notebooks:
    name: Test with Python ${{ matrix.python-version }}
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        python-version: ${{ fromJson(inputs.python-versions) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install pytest nbval ipykernel
          python -m ipykernel install --user
          python -m pip install -e .

      - name: Update notebook kernels
        run: |
          for nb in tests/*.ipynb; do
            sed -i 's/"kernel": "mrs"/"kernel": "python3"/g' $nb
            sed -i 's/"name": "mrs"/"name": "python3"/g' $nb
          done

      - name: Run notebook tests
        run: pytest --nbval-lax --current-env tests/

      - name: Upload executed notebooks on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: executed-notebooks-py${{ matrix.python-version }}
          path: tests/*_executed.ipynb
